name: Auto-crear PRs para Feature

on:
  create:
  push:
    branches:
      - 'feature/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  create-prs:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/feature/')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}
      
      - name: Crear labels si no existen
        run: |
          # Crear label 'feature' si no existe
          gh label create feature --color 0E8A16 --description "Feature branch" --force || true
          
          # Crear label 'auto-created' si no existe
          gh label create auto-created --color 1D76DB --description "Creado automÃ¡ticamente" --force || true
          
          echo "âœ“ Labels verificados/creados"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extraer informaciÃ³n de feature
        id: feature
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # feature/backend-auth-API-123 -> backend-auth-API-123
          FEATURE_NAME="${BRANCH_NAME#feature/}"
          echo "name=$FEATURE_NAME" >> $GITHUB_OUTPUT
          
          echo "Branch: $BRANCH_NAME"
          echo "Feature: $FEATURE_NAME"
      
      - name: Verificar si PRs ya existen
        id: check
        run: |
          # Verificar PR a dev
          DEV_PR=$(gh pr list --base dev --head ${{ steps.feature.outputs.branch }} --json number --jq '.[0].number' || echo "")
          echo "dev_exists=$([[ -n "$DEV_PR" ]] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
          
          # Verificar PR a stg
          STG_PR=$(gh pr list --base stg --head ${{ steps.feature.outputs.branch }} --json number --jq '.[0].number' || echo "")
          echo "stg_exists=$([[ -n "$STG_PR" ]] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
          
          # Verificar PR a main
          MAIN_PR=$(gh pr list --base main --head ${{ steps.feature.outputs.branch }} --json number --jq '.[0].number' || echo "")
          echo "main_exists=$([[ -n "$MAIN_PR" ]] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Crear PR a dev
        id: create-dev
        if: steps.check.outputs.dev_exists == 'false'
        run: |
          BODY=$(cat <<'EOF'
          ## PR #1: Feature â†’ dev
          **PropÃ³sito:** Testing inicial y validaciÃ³n CI/CD
          
          ### Checklist
          - [ ] Tests pasando
          - [ ] Linter OK
          - [ ] Build exitoso
          
          ---
          *Este PR fue creado automÃ¡ticamente*
          EOF
          )
          
          if gh pr create \
            --base dev \
            --head ${{ steps.feature.outputs.branch }} \
            --title "[DEV] ${{ steps.feature.outputs.name }}" \
            --body "$BODY" \
            --label "feature,auto-created"; then
            echo "created=true" >> $GITHUB_OUTPUT
            echo "âœ“ PR a dev creado"
          else
            echo "created=false" >> $GITHUB_OUTPUT
            echo "âœ— Error al crear PR a dev"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Crear PR a stg
        id: create-stg
        if: steps.check.outputs.stg_exists == 'false'
        run: |
          BODY=$(cat <<'EOF'
          ## PR #2: Feature â†’ stg
          
          **PropÃ³sito:** QA testing y validaciÃ³n de stakeholders
          
          ### Requisitos
          - [ ] PR a dev mergeado âœ“
          - [ ] Tests en dev OK
          - [ ] QA aprobado
          
          ### Checklist
          - [ ] Testing manual completo
          - [ ] ValidaciÃ³n stakeholders
          - [ ] Sin bugs crÃ­ticos
          
          ---
          *Este PR fue creado automÃ¡ticamente. Solo mergear despuÃ©s de que dev estÃ© OK*
          EOF
          )
          
          if gh pr create \
            --base stg \
            --head ${{ steps.feature.outputs.branch }} \
            --title "[STG] ${{ steps.feature.outputs.name }}" \
            --body "$BODY" \
            --draft \
            --label "feature,auto-created"; then
            echo "created=true" >> $GITHUB_OUTPUT
            echo "âœ“ PR a stg creado (draft)"
          else
            echo "created=false" >> $GITHUB_OUTPUT
            echo "âœ— Error al crear PR a stg"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Crear PR a main
        id: create-main
        if: steps.check.outputs.main_exists == 'false'
        run: |
          BODY=$(cat <<'EOF'
          ## PR #3: Feature â†’ main
          
          **PropÃ³sito:** Release a producciÃ³n
          
          ### Requisitos
          - [ ] PR a dev mergeado âœ“
          - [ ] PR a stg mergeado âœ“
          - [ ] QA aprobado en stg
          - [ ] 2+ aprobaciones tech lead
          
          ### Checklist
          - [ ] Tests pasando en todos los ambientes
          - [ ] QA sign-off completo
          - [ ] DocumentaciÃ³n actualizada
          - [ ] Release notes preparadas
          
          ---
          *Este PR fue creado automÃ¡ticamente. Solo mergear despuÃ©s de que stg estÃ© OK*
          EOF
          )
          
          if gh pr create \
            --base main \
            --head ${{ steps.feature.outputs.branch }} \
            --title "[PROD] ${{ steps.feature.outputs.name }}" \
            --body "$BODY" \
            --draft \
            --label "feature,auto-created"; then
            echo "created=true" >> $GITHUB_OUTPUT
            echo "âœ“ PR a main creado (draft)"
          else
            echo "created=false" >> $GITHUB_OUTPUT
            echo "âœ— Error al crear PR a main"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Resumen
        if: always()
        run: |
          echo "### ðŸ“‹ Resumen de PRs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Feature: \`${{ steps.feature.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.check.outputs.dev_exists }}" == "true" ]]; then
            echo "- â­ï¸  PR a \`dev\`: Ya existe" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.create-dev.outputs.created }}" == "true" ]]; then
            echo "- âœ“ PR a \`dev\`: Creado" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸  PR a \`dev\`: No creado" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ steps.check.outputs.stg_exists }}" == "true" ]]; then
            echo "- â­ï¸  PR a \`stg\`: Ya existe" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.create-stg.outputs.created }}" == "true" ]]; then
            echo "- âœ“ PR a \`stg\`: Creado (draft)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸  PR a \`stg\`: No creado" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ steps.check.outputs.main_exists }}" == "true" ]]; then
            echo "- â­ï¸  PR a \`main\`: Ya existe" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.create-main.outputs.created }}" == "true" ]]; then
            echo "- âœ“ PR a \`main\`: Creado (draft)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸  PR a \`main\`: No creado" >> $GITHUB_STEP_SUMMARY
          fi